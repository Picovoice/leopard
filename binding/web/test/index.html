<!--
  Copyright 2021 Picovoice Inc.
  You may not use this file except in compliance with the license. A copy of the license is located in the "LICENSE"
  file accompanying this source.
  Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
  an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
  specific language governing permissions and limitations under the License.
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <script src="index.js"></script>
  <script type="application/javascript">
    const Leopard = LeopardWeb.Leopard
    let leopard

    var audioContext = new (window.AudioContext || window.webKitAudioContext)(
      { sampleRate: 16000 }
    );

    function writeStatus(status) {
      console.log(status);
      document.getElementById("status").innerHTML = status;
    }

    function readAudioFile(selectedFile, callback) {
      let reader = new FileReader();
      reader.onload = function(ev) {
        let wavBytes = reader.result;
        audioContext.decodeAudioData(wavBytes, callback);
      };
      reader.readAsArrayBuffer(selectedFile);
    }

    function urlContentToDataUri(url){
      return fetch(url)
        .then( response => response.blob() )
        .then( blob => new Promise( callback =>{
          let reader = new FileReader();
          reader.onload = function() {
            let dataUrl = reader.result;
            let base64 = dataUrl.split(',')[1];
            callback(base64);
          };
          reader.readAsDataURL(blob);
        }) ) ;
    }

    async function startLeopard(accessKey) {
      writeStatus("Leopard is loading. Please wait...");

      const wasm_base64 = await urlContentToDataUri("./pv_leopard.wasm")
      const model_base64 = await urlContentToDataUri("./leopard_params.pv")
      leopard = await Leopard.create(accessKey, wasm_base64, model_base64)

      writeStatus(`Leopard loaded. Leopard version: ${leopard.version}`)

      const fileSelector = document.getElementById("file-selector");
      fileSelector.addEventListener("change", (event) => {
        const fileList = event.target.files;
        readAudioFile(fileList[0], async (audioBuffer) => {
          const f32PCM = audioBuffer.getChannelData(0);
          const i16PCM = new Int16Array(f32PCM.length);

          const INT16_MAX = 32767;
          const INT16_MIN = -32768;
          i16PCM.set(
            f32PCM.map((f) => {
              let i = Math.trunc(f * INT16_MAX);
              if (f > INT16_MAX) i = INT16_MAX;
              if (f < INT16_MIN) i = INT16_MIN;
              return i;
            })
          );

          const transcription = await leopard.process(i16PCM)
          document.getElementById('result').innerText = transcription
        });
      });
    }
  </script>
  <style>
      table {
          margin-top: 2rem;
          display: inline-block;
          overflow: auto;
      }

      table {
          border-collapse: separate;
      }

      td {
          text-align: right;
          vertical-align: middle;
      }

      tr:nth-child(even) {
          background: #eee;
      }
  </style>
</head>

<body>
  <h1>Leopard Web Demo - Worker</h1>
  <p>
    This demo uses Leopard for Web to create an Leopard Web Worker that can
    index and search audio files. For details, look at your browser's console.
  </p>
  <label for="accessKey"
  >AccessKey provided by
    <a href="https://picovoice.ai/console/">Picovoice Console</a>:</label
  >
  <input type="text" id="accessKey" name="accessKey" />
  <input
    type="button"
    id="submit"
    value="Start Leopard"
    onclick="startLeopard(document.getElementById('accessKey').value)"
  />
  <hr />

  <div id="dashboard">
    <div>
      <p>Select audio file:</p>
      <input type="file" id="file-selector" />
    </div>
    <br />
  </div>

  <div id="status"></div>
  <br />
  <p id="result"></p>
</body>
</html>
