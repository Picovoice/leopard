<!DOCTYPE html>
<html lang="en">

<head>
  <title>unit test - LeopardWeb</title>
  <script src="../dist/iife/index.js"></script>
  <script src="./leopard_params.js"></script>
  <script type="application/javascript">
    const expected = "Mr. Quilter is the apostle of the middle classes and we are glad to welcome his gospel.";
    const expectedWords = [
      {word: 'Mr'       , startSec: 0.576, endSec: 0.800},
      {word: 'quilter'  , startSec: 0.864, endSec: 1.184},
      {word: 'is'       , startSec: 1.312, endSec: 1.376},
      {word: 'the'      , startSec: 1.440, endSec: 1.503},
      {word: 'apostle'  , startSec: 1.568, endSec: 2.080},
      {word: 'of'       , startSec: 2.176, endSec: 2.240},
      {word: 'the'      , startSec: 2.304, endSec: 2.336},
      {word: 'middle'   , startSec: 2.400, endSec: 2.592},
      {word: 'classes'  , startSec: 2.688, endSec: 3.168},
      {word: 'and'      , startSec: 3.360, endSec: 3.456},
      {word: 'we'       , startSec: 3.520, endSec: 3.552},
      {word: 'are'      , startSec: 3.648, endSec: 3.648},
      {word: 'glad'     , startSec: 3.744, endSec: 4.032},
      {word: 'to'       , startSec: 4.096, endSec: 4.160},
      {word: 'welcome'  , startSec: 4.223, endSec: 4.576},
      {word: 'his'      , startSec: 4.672, endSec: 4.832},
      {word: 'gospel'   , startSec: 4.928, endSec: 5.376},
    ];
    let pcm = null;

    window.onload = function () {
      const audioContext = new (window.AudioContext || window.webKitAudioContext)(
              {sampleRate: 16000}
      );

      function readAudioFile(selectedFile, callback) {
        let reader = new FileReader();
        reader.onload = function (ev) {
          let wavBytes = reader.result;
          audioContext.decodeAudioData(wavBytes, callback);
        };
        reader.readAsArrayBuffer(selectedFile);
      }

      const fileSelector = document.getElementById("audioFile");
      fileSelector.addEventListener("change", (event) => {
        document.getElementById("audioLoaded").style.display = "none";

        writeMessage("Loading audio file...");
        const fileList = event.target.files;
        readAudioFile(fileList[0], (audioBuffer) => {
          const f32PCM = audioBuffer.getChannelData(0);
          const i16PCM = new Int16Array(f32PCM.length);

          const INT16_MAX = 32767;
          const INT16_MIN = -32768;
          i16PCM.set(
                  f32PCM.map((f) => {
                    let i = Math.trunc(f * INT16_MAX);
                    if (f > INT16_MAX) i = INT16_MAX;
                    if (f < INT16_MIN) i = INT16_MIN;
                    return i;
                  })
          );
          pcm = i16PCM;
          document.getElementById("audioLoaded").style.display = "block";
          writeMessage("Loading audio file... done!");
        });
      });
    }

    function writeMessage(message) {
      console.log(message);
      let p = document.createElement("p");
      let text = document.createTextNode(message);
      p.appendChild(text);
      document.body.appendChild(p);
    }

    function assertEquals(expected, actual, failureMessage) {
      if (expected !== actual) {
        throw new Error(failureMessage);
      }
    }

    function assertDeepEquals(expected, actual, epsilon=0.001) {
      expected.forEach(obj => {
        Object.keys(obj).forEach((key, i) => {
          const e = expected[i];
          const a = actual[i];
          if (a[key] === undefined) {
            throw new Error(`'actual' value does not have key '${key}'`);
          }
          if (typeof e[key] !== typeof a[key]) {
            throw new Error(`type mismatch`)
          }
          if (typeof e[key] === "string") {
            if (e[key] !== a[key]) {
              throw new Error(`value mismatch at index ${i}`)
            }
          }
          if (typeof e[key] === "number") {
            if (Math.abs(e[key] - a[key]) > epsilon) {
              throw new Error(`value mismatch at index ${i}`)
            }
          }
        });
      });
    }

    async function startTest() {
      document.getElementById("testComplete").style.display = "none";
      let is_failed = undefined

      writeMessage("Starting test...");

      const accessKey = document.getElementById("accessKey").value;

      if (!pcm) {
        writeMessage("Audio file not provided...");
        return
      }

      try {
        writeMessage("Checking Leopard 'fromPublicDirectory'");
        let handle = await LeopardWeb.Leopard.fromPublicDirectory(accessKey, "leopard_params.pv", { forceWrite: true });
        let result = await handle.process(pcm);
        console.log(result)
        assertEquals(expected, result.transcription, 'Failed to transcribe audio file');
        assertDeepEquals(expectedWords, result.words);
        handle.release()
        writeMessage("Checking Leopard 'fromPublicDirectory'... done!");

        writeMessage("Checking Leopard 'fromBase64'");
        handle = await LeopardWeb.Leopard.fromBase64(accessKey, modelParams, { forceWrite: true });
        result = await handle.process(pcm);
        assertEquals(expected, result.transcription, 'Failed to transcribe audio file');
        assertDeepEquals(expectedWords, result.words);
        handle.release()
        writeMessage("Checking Leopard 'fromBase64'... done!");

        writeMessage("Checking LeopardWorker 'fromPublicDirectory'");
        handle = await LeopardWeb.LeopardWorker.fromPublicDirectory(accessKey, "leopard_params.pv", { forceWrite: true });
        result = await handle.process(pcm);
        assertEquals(expected, result.transcription, 'Failed to transcribe audio file');
        assertDeepEquals(expectedWords, result.words);
        handle.release()
        writeMessage("Checking LeopardWorker 'fromPublicDirectory'... done!");

        writeMessage("Checking LeopardWorker 'fromBase64'");
        handle = await LeopardWeb.LeopardWorker.fromBase64(accessKey, modelParams, { forceWrite: true });
        result = await handle.process(pcm);
        assertEquals(expected, result.transcription, 'Failed to transcribe audio file');
        assertDeepEquals(expectedWords, result.words);
        handle.release()
        writeMessage("Checking LeopardWorker 'fromBase64'... done!");

        writeMessage("Checking LeopardWorker 'transfer buffer'");
        handle = await LeopardWeb.LeopardWorker.fromPublicDirectory(accessKey, "leopard_params.pv");
        const defaultLen = pcm.length;
        result = await handle.process(pcm, { transfer: true, transferCB: (data) => {pcm = data} });
        assertEquals(expected, result.transcription, 'Failed to transcribe audio file');
        assertDeepEquals(expectedWords, result.words);
        assertEquals(pcm.length, defaultLen, 'Buffer failed to transfer');
        handle.release()
        writeMessage("Checking LeopardWorker 'transfer buffer'... done!");

        writeMessage("Checking invalid public path");
        is_failed = false
        try {
          await LeopardWeb.Leopard.fromPublicDirectory(accessKey, "invalid", { forceWrite: true });
        } catch (e) {
          is_failed = true;
        }
        assertEquals(true, is_failed, 'Failed to handle invalid path');

        is_failed = false
        try {
          await LeopardWeb.LeopardWorker.fromPublicDirectory(accessKey, "invalid", { forceWrite: true });
        } catch (e) {
          is_failed = true;
        }
        assertEquals(true, is_failed, 'Failed to handle invalid path');
        writeMessage("Checking invalid public path... done!");

        writeMessage("Checking invalid base64 string");
        is_failed = false
        try {
          await LeopardWeb.Leopard.fromBase64(accessKey, "invalid", { forceWrite: true });
        } catch (e) {
          is_failed = true;
        }
        assertEquals(true, is_failed, 'Failed to handle invalid base64 string');

        is_failed = false
        try {
          await LeopardWeb.LeopardWorker.fromBase64(accessKey, "invalid", { forceWrite: true });
        } catch (e) {
          is_failed = true;
        }
        assertEquals(true, is_failed, 'Failed to handle invalid base64 string');
        writeMessage("Checking invalid base64 string... done!");

        writeMessage("Checking invalid access key");
        is_failed = false
        try {
          await LeopardWeb.Leopard.fromPublicDirectory("invalid", "leopard_params.pv");
        } catch (e) {
          is_failed = true;
        }
        assertEquals(true, is_failed, 'Failed to handle invalid access key');

        is_failed = false
        try {
          await LeopardWeb.LeopardWorker.fromPublicDirectory("invalid", "leopard_params.pv");
        } catch (e) {
          is_failed = true;
        }
        assertEquals(true, is_failed, 'Failed to handle invalid access key');
        writeMessage("Checking invalid access key... done!");

        writeMessage("Test passed!")
      } catch (error) {
        writeMessage(error);
        writeMessage("Test failed!")
      } finally {
        document.getElementById("testComplete").style.display = "block";
      }
    }

    const numIterations = 15;
    async function performanceTest() {
      document.getElementById("testComplete").style.display = "none";

      const accessKey = document.getElementById("accessKey").value;
      let handle = null;

      try {
        writeMessage("Starting init performance test!");
        let start = Date.now();
        for (let i = 0; i < numIterations; i++) {
          handle = await LeopardWeb.LeopardWorker.fromBase64(accessKey, modelParams, {forceWrite: true});
          handle.terminate();
        }
        let end = Date.now();
        writeMessage(`Init Performance: ${((end - start) / 1000) / numIterations}`);

        handle = await LeopardWeb.LeopardWorker.fromBase64(accessKey, modelParams, {forceWrite: true});
        writeMessage("Starting process performance test!");
        start = Date.now();
        for (let i = 0; i < numIterations; i++) {
          await handle.process(pcm);
        }
        end = Date.now();
        writeMessage(`Process Performance: ${((end - start) / 1000) / numIterations}`);
      } catch (e) {
        writeMessage("Test failed!")
      } finally {
        document.getElementById("testComplete").style.display = "block";
      }
    }
  </script>
</head>

<body>
<h1>Leopard web binding test</h1>
<p>After entering the AccessKey and audio file, click the "Test Leopard" button. For the result, refer to the
  browser console.</p>

<p>
  <label for="accessKey">AccessKey string obtained from
    <a href="https://picovoice.ai/console/">Picovoice Console</a>:</label>
  <input type="text" id="accessKey" name="accessKey"/>
</p>

<p>
  <label for="audioFile">Select audio file located on
    {PROJECT_ROOT}/resources/audio_samples/test.wav:</label>
  <input type="file" id="audioFile" name="audioFile" accept="audio/*"/>
</p>

<input type="button" id="sumbit" value="Test Leopard" onclick="startTest()"/>
<input type="button" id="perfTest" value="Test Leopard Performance" onclick="performanceTest()"/>

<br>

<h4 id="audioLoaded" style="display: none;">Audio file loaded!</h4>
<h4 id="testComplete" style="display: none;">Test Complete!</h4>
<hr/>
</body>

</html>
